name: Build LLVM Config Binaries

on:
  workflow_dispatch:

jobs:
  build-llvm-config:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-2025
            arch: x86_64
            host: x64
            targets: X86
          - os: windows-11-arm
            arch: arm64
            host: arm64
            targets: AArch64
    steps:
      - name: Set up MSVC Developer Command Prompt
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.host }}

      - name: Download LLVM sources
        shell: pwsh
        run: |
          $url = "https://github.com/llvm/llvm-project/releases/download/llvmorg-17.0.6/llvm-project-17.0.6.src.tar.xz"
          $archive = "$(Resolve-Path .)\llvm-src.tar.xz"
          Invoke-WebRequest -Uri $url -OutFile $archive
          tar -xf $archive -C .

      - name: Configure build
        shell: pwsh
        run: |
          cmake -S llvm-project-17.0.6.src/llvm `
            -B build `
            -G "Ninja" `
            -DLLVM_TARGETS_TO_BUILD="${{ matrix.targets }}" `
            -DLLVM_INCLUDE_TESTS=OFF `
            -DLLVM_INCLUDE_EXAMPLES=OFF `
            -DLLVM_INCLUDE_BENCHMARKS=OFF `
            -DLLVM_BUILD_TOOLS=ON `
            -DCMAKE_BUILD_TYPE=Release

      - name: Build llvm-config
        shell: pwsh
        run: |
          cmake --build build --target llvm-config --config Release

      - name: Upload llvm-config artifact
        uses: actions/upload-artifact@v4
        with:
          name: llvm-config-windows-${{ matrix.arch }}
          path: build/bin/llvm-config.exe

      - name: Upload llvm-config to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/bin/llvm-config.exe
          asset_name: llvm-config-windows-${{ matrix.arch }}-17.0.6.exe
          tag: llvm-config-17.0.6
          release_name: llvm-config-17.0.6
          overwrite: true
