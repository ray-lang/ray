name: Build Windows CLI

on:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  metadata:
    runs-on: ubuntu-latest
    outputs:
      ref_label: ${{ steps.release-label.outputs.ref_label }}
      channel_hint: ${{ steps.release-label.outputs.channel_hint }}
    steps:
      - name: Determine release label
        id: release-label
        run: |
          EVENT="${GITHUB_EVENT_NAME}"
          REF_TYPE="${GITHUB_REF_TYPE:-}"
          REF_NAME="${GITHUB_REF_NAME:-}"

          if [ "$EVENT" = "schedule" ]; then
            LABEL="nightly-$(date -u +%Y-%m-%d)"
          elif [ "$EVENT" = "workflow_dispatch" ] && [ "$REF_TYPE" != "tag" ]; then
            LABEL="nightly-$(date -u +%Y-%m-%d)"
          elif [ "$REF_TYPE" = "tag" ]; then
            LABEL="$REF_NAME"
          else
            LABEL="$REF_NAME"
          fi

          if [ "$REF_TYPE" = "tag" ]; then
            CHANNEL="stable"
          elif [[ "$LABEL" == nightly-* ]]; then
            CHANNEL="nightly"
          else
            CHANNEL="nightly"
          fi

          echo "ref_label=$LABEL" >> "$GITHUB_OUTPUT"
          echo "channel_hint=$CHANNEL" >> "$GITHUB_OUTPUT"

  windows-x86_64:
    needs: metadata
    runs-on: windows-2025
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Build Windows x86_64 CLI
        uses: ./.github/actions/ray-build
        with:
          system: windows
          arch: x86_64
          ref-label: ${{ needs.metadata.outputs.ref_label }}
          channel-hint: ${{ needs.metadata.outputs.channel_hint }}
          packages: |
            pwsh -Command "
              choco install llvm --version=17.0.6 --allow-downgrade -y
              $install = 'C:\Program Files\LLVM'
              $prefix = 'C:\llvm-x64'
              if (Test-Path $prefix) { Remove-Item -Recurse -Force $prefix }
              Copy-Item -Recurse -Force $install $prefix
              Write-Output \"Using LLVM prefix: $prefix\"
              Write-Output ($prefix + '\bin') | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
              Write-Output ('LLVM_SYS_170_PREFIX=' + $prefix) | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
              Write-Output ('LLVM_SYS_CONFIG_PATH=' + $prefix + '\bin\llvm-config.exe') | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            "
          repo-token: ${{ secrets.GITHUB_TOKEN }}

  windows-arm64:
    needs: metadata
    runs-on: windows-11-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Build Windows arm64 CLI
        uses: ./.github/actions/ray-build
        with:
          system: windows
          arch: arm64
          ref-label: ${{ needs.metadata.outputs.ref_label }}
          channel-hint: ${{ needs.metadata.outputs.channel_hint }}
          packages: |
            pwsh -Command "
              choco install llvm --version=17.0.6 --allow-downgrade -y
              $install = 'C:\Program Files\LLVM'
              $prefix = 'C:\llvm-arm64'
              if (Test-Path $prefix) { Remove-Item -Recurse -Force $prefix }
              Copy-Item -Recurse -Force $install $prefix
              Write-Output \"Using LLVM prefix: $prefix\"
              Write-Output ($prefix + '\bin') | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
              Write-Output ('LLVM_SYS_170_PREFIX=' + $prefix) | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
              Write-Output ('LLVM_SYS_CONFIG_PATH=' + $prefix + '\bin\llvm-config.exe') | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            "
          repo-token: ${{ secrets.GITHUB_TOKEN }}
