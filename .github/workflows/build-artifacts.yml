name: Build Artifacts

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"
  schedule:
    - cron: "0 5 * * *"

env:
  CARGO_TERM_COLOR: always

jobs:
  metadata:
    runs-on: ubuntu-latest
    outputs:
      ref_label: ${{ steps.release-label.outputs.ref_label }}
      channel_hint: ${{ steps.release-label.outputs.channel_hint }}
    steps:
      - name: Determine release label
        id: release-label
        run: |
          EVENT="${GITHUB_EVENT_NAME}"
          REF_TYPE="${GITHUB_REF_TYPE:-}"
          REF_NAME="${GITHUB_REF_NAME:-}"

          if [ "$EVENT" = "schedule" ]; then
            LABEL="nightly-$(date -u +%Y-%m-%d)"
          elif [ "$EVENT" = "workflow_dispatch" ] && [ "$REF_TYPE" != "tag" ]; then
            LABEL="nightly-$(date -u +%Y-%m-%d)"
          elif [ "$REF_TYPE" = "tag" ]; then
            LABEL="$REF_NAME"
          else
            LABEL="$REF_NAME"
          fi

          if [ "$REF_TYPE" = "tag" ]; then
            CHANNEL="stable"
          elif [[ "$LABEL" == nightly-* ]]; then
            CHANNEL="nightly"
          else
            CHANNEL="nightly"
          fi

          echo "ref_label=$LABEL" >> "$GITHUB_OUTPUT"
          echo "channel_hint=$CHANNEL" >> "$GITHUB_OUTPUT"

  linux-x86_64:
    needs: metadata
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Build Linux x86_64 CLI
        uses: ./.github/actions/ray-build
        with:
          system: linux
          arch: x86_64
          ref-label: ${{ needs.metadata.outputs.ref_label }}
          channel-hint: ${{ needs.metadata.outputs.channel_hint }}
          packages: |
            sudo apt-get update
            sudo apt-get install -y llvm-17 lld-17 liblld-17-dev libpolly-17-dev clang-17 libclang-17-dev
            echo "/usr/lib/llvm-17/bin" >> "$GITHUB_PATH"
          repo-token: ${{ secrets.GITHUB_TOKEN }}

  linux-arm64:
    needs: metadata
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Build Linux arm64 CLI
        uses: ./.github/actions/ray-build
        with:
          system: linux
          arch: arm64
          ref-label: ${{ needs.metadata.outputs.ref_label }}
          channel-hint: ${{ needs.metadata.outputs.channel_hint }}
          packages: |
            sudo apt-get update
            sudo apt-get install -y llvm-17 lld-17 liblld-17-dev libpolly-17-dev clang-17 libclang-17-dev
            echo "/usr/lib/llvm-17/bin" >> "$GITHUB_PATH"
          repo-token: ${{ secrets.GITHUB_TOKEN }}

  macos-arm64:
    needs: metadata
    runs-on: macos-15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Build macOS arm64 CLI
        uses: ./.github/actions/ray-build
        with:
          system: macos
          arch: arm64
          ref-label: ${{ needs.metadata.outputs.ref_label }}
          channel-hint: ${{ needs.metadata.outputs.channel_hint }}
          packages: |
            brew update
            brew install llvm@17
            LLVM_PREFIX=$(brew --prefix llvm@17)
            echo "$LLVM_PREFIX/bin" >> "$GITHUB_PATH"
          repo-token: ${{ secrets.GITHUB_TOKEN }}

  macos-x86_64:
    needs: metadata
    runs-on: macos-15-intel
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Build macOS x86_64 CLI
        uses: ./.github/actions/ray-build
        with:
          system: macos
          arch: x86_64
          ref-label: ${{ needs.metadata.outputs.ref_label }}
          channel-hint: ${{ needs.metadata.outputs.channel_hint }}
          packages: |
            brew update
            brew install llvm@17
            LLVM_PREFIX=$(brew --prefix llvm@17)
            echo "$LLVM_PREFIX/bin" >> "$GITHUB_PATH"
          repo-token: ${{ secrets.GITHUB_TOKEN }}

  windows-x86_64:
    needs: metadata
    runs-on: windows-2025
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Build Windows x86_64 CLI
        uses: ./.github/actions/ray-build
        with:
          system: windows
          arch: x86_64
          ref-label: ${{ needs.metadata.outputs.ref_label }}
          channel-hint: ${{ needs.metadata.outputs.channel_hint }}
          packages: |
            set -euo pipefail
            LLVM_ZIP_URL="https://github.com/ray-lang/llvm-build/releases/download/windows-llvm-17.0.6/windows-x64-llvm-17.0.6.zip"
            LLVM_PREFIX="C:/llvm-x64"
            pwsh -Command "
              \$ErrorActionPreference = 'Stop'
              \$zipUrl = '$LLVM_ZIP_URL'
              \$zipPath = 'C:\llvm-x64.zip'
              \$installDir = 'C:\llvm-x64'
              Write-Host ('Downloading prebuilt LLVM bundle from ' + \$zipUrl)
              Invoke-WebRequest -Uri \$zipUrl -OutFile \$zipPath
              if (Test-Path \$installDir) { Remove-Item -Recurse -Force \$installDir }
              New-Item -ItemType Directory -Force -Path \$installDir | Out-Null
              Expand-Archive -Path \$zipPath -DestinationPath \$installDir -Force
              Remove-Item -Force \$zipPath
            "
            echo "$LLVM_PREFIX/bin" >> "$GITHUB_PATH"
            echo "LLVM_SYS_170_PREFIX=$LLVM_PREFIX" >> "$GITHUB_ENV"
            echo "LLVM_SYS_CONFIG_PATH=$LLVM_PREFIX/bin/llvm-config.exe" >> "$GITHUB_ENV"
          repo-token: ${{ secrets.GITHUB_TOKEN }}

  windows-arm64:
    needs: metadata
    runs-on: windows-11-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Build Windows arm64 CLI
        uses: ./.github/actions/ray-build
        with:
          system: windows
          arch: arm64
          ref-label: ${{ needs.metadata.outputs.ref_label }}
          channel-hint: ${{ needs.metadata.outputs.channel_hint }}
          packages: |
            set -euo pipefail
            LLVM_ZIP_URL="https://github.com/ray-lang/llvm-build/releases/download/windows-llvm-17.0.6/windows-arm64-llvm-17.0.6.zip"
            LLVM_PREFIX="C:/llvm-arm64"
            pwsh -Command "
              \$ErrorActionPreference = 'Stop'
              \$zipUrl = '$LLVM_ZIP_URL'
              \$zipPath = 'C:\llvm-arm64.zip'
              \$installDir = 'C:\llvm-arm64'
              Write-Host ('Downloading prebuilt LLVM bundle from ' + \$zipUrl)
              Invoke-WebRequest -Uri \$zipUrl -OutFile \$zipPath
              if (Test-Path \$installDir) { Remove-Item -Recurse -Force \$installDir }
              New-Item -ItemType Directory -Force -Path \$installDir | Out-Null
              Expand-Archive -Path \$zipPath -DestinationPath \$installDir -Force
              Remove-Item -Force \$zipPath
            "
            echo "$LLVM_PREFIX/bin" >> "$GITHUB_PATH"
            echo "LLVM_SYS_170_PREFIX=$LLVM_PREFIX" >> "$GITHUB_ENV"
            echo "LLVM_SYS_CONFIG_PATH=$LLVM_PREFIX/bin/llvm-config.exe" >> "$GITHUB_ENV"
          repo-token: ${{ secrets.GITHUB_TOKEN }}

  toolchain:
    needs: 
      - metadata
      - linux-x86_64
    runs-on: ubuntu-latest
    env:
      REF_LABEL: ${{ needs.metadata.outputs.ref_label }}
      CHANNEL_HINT: ${{ needs.metadata.outputs.channel_hint }}
      TOOLCHAIN_BASENAME: ray-toolchain-${{ needs.metadata.outputs.ref_label }}
      LINUX_CLI_BASENAME: ray-cli-linux-x86_64-${{ needs.metadata.outputs.ref_label }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Linux CLI artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.LINUX_CLI_BASENAME }}
          path: dist

      - name: Install CLI artifact
        run: |
          mkdir -p target/release
          cp dist/${LINUX_CLI_BASENAME} target/release/ray
          chmod +x target/release/ray

      - name: Prepare toolchain layout
        run: |
          mkdir -p build/toolchain/lib build/toolchain/build
          ./target/release/ray --root-path $PWD/build/toolchain build lib/core --lib --no-core
          cp lib/core/.raylib build/toolchain/lib/core.raylib
          printf 'version = "%s"\nchannel = "%s"\n' "${REF_LABEL}" "${CHANNEL_HINT}" > build/toolchain/manifest.toml
          rm -rf build/toolchain/build

      - name: Archive toolchain
        run: |
          set -euo pipefail
          tar -C build/toolchain -czf build/${TOOLCHAIN_BASENAME}.tar.gz .

      - name: Generate checksum
        run: |
          shasum -a 256 build/${TOOLCHAIN_BASENAME}.tar.gz > build/${TOOLCHAIN_BASENAME}.tar.gz.sha256

      - name: Upload toolchain artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.TOOLCHAIN_BASENAME }}
          path: |
            build/${{ env.TOOLCHAIN_BASENAME }}.tar.gz
            build/${{ env.TOOLCHAIN_BASENAME }}.tar.gz.sha256

      - name: Upload toolchain archive to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/${{ env.TOOLCHAIN_BASENAME }}.tar.gz
          asset_name: ${{ env.TOOLCHAIN_BASENAME }}.tar.gz
          tag: ${{ env.REF_LABEL }}
          release_name: ${{ env.REF_LABEL }}
          prerelease: ${{ github.ref_type != 'tag' }}
          overwrite: true

      - name: Upload toolchain checksum to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/${{ env.TOOLCHAIN_BASENAME }}.tar.gz.sha256
          asset_name: ${{ env.TOOLCHAIN_BASENAME }}.tar.gz.sha256
          tag: ${{ env.REF_LABEL }}
          release_name: ${{ env.REF_LABEL }}
          prerelease: ${{ github.ref_type != 'tag' }}
          overwrite: true

      - name: Upload manifest to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/toolchain/manifest.toml
          asset_name: ray-toolchain-manifest-${{ env.REF_LABEL }}.toml
          tag: ${{ env.REF_LABEL }}
          release_name: ${{ env.REF_LABEL }}
          prerelease: ${{ github.ref_type != 'tag' }}
          overwrite: true

  prune-nightlies:
    needs:
      - linux-x86_64
      - linux-arm64
      - macos-arm64
      - macos-x86_64
      - windows-x86_64
      - windows-arm64
      - toolchain
    if: github.ref_type != 'tag'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout-cone-mode: false
          sparse-checkout: ''
          depth: 1

      - name: Prune old nightly releases
        env:
          # Guaranteed workflow token + repo
          GH_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -eo pipefail

          # Optional: debug what gh sees
          echo "Auth status:"
          gh auth status || true

          echo "Listing nightly releases for $GITHUB_REPOSITORY"
          nightlies=$(
            gh release list \
              --repo "$GITHUB_REPOSITORY" \
              --limit 100 \
              --json tagName \
              --jq 'map(.tagName) | map(select(startswith("nightly-"))) | sort'
          )
          echo "Nightlies JSON: $nightlies"

          count=$(echo "$nightlies" | jq 'length')
          echo "Found $count nightly releases"

          if [ "$count" -le 7 ]; then
            echo "Nothing to prune"
            exit 0
          fi

          to_delete_count=$((count - 7))
          echo "Will delete $to_delete_count oldest nightlies"

          tags=$(echo "$nightlies" | jq -r ".[0:${to_delete_count}][]")
          echo "Tags to delete:"
          printf '  - %s\n' $tags

          for tag in $tags; do
            echo "Deleting release $tag"
            # You can temporarily try 'gh release view' first if you want:
            # gh release view "$tag" --repo "$GITHUB_REPOSITORY" || echo "view failed"
            gh release delete "$tag" \
              --repo "$GITHUB_REPOSITORY" \
              --cleanup-tag \
              -y || true
          done
