name: Build Artifacts

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"
  schedule:
    - cron: "0 5 * * *"

env:
  CARGO_TERM_COLOR: always

jobs:
  metadata:
    runs-on: ubuntu-latest
    outputs:
      ref_label: ${{ steps.release-label.outputs.ref_label }}
      channel_hint: ${{ steps.release-label.outputs.channel_hint }}
    steps:
      - name: Determine release label
        id: release-label
        run: |
          EVENT="${GITHUB_EVENT_NAME}"
          REF_TYPE="${GITHUB_REF_TYPE:-}"
          REF_NAME="${GITHUB_REF_NAME:-}"

          if [ "$EVENT" = "schedule" ]; then
            LABEL="nightly-$(date -u +%Y-%m-%d)"
          elif [ "$EVENT" = "workflow_dispatch" ] && [ "$REF_TYPE" != "tag" ]; then
            LABEL="nightly-$(date -u +%Y-%m-%d)"
          elif [ "$REF_TYPE" = "tag" ]; then
            LABEL="$REF_NAME"
          else
            LABEL="$REF_NAME"
          fi

          if [ "$REF_TYPE" = "tag" ]; then
            CHANNEL="stable"
          elif [[ "$LABEL" == nightly-* ]]; then
            CHANNEL="nightly"
          else
            CHANNEL="nightly"
          fi

          echo "ref_label=$LABEL" >> "$GITHUB_OUTPUT"
          echo "channel_hint=$CHANNEL" >> "$GITHUB_OUTPUT"

  linux-x86_64:
    needs: metadata
    runs-on: ubuntu-24.04
    steps:
      - name: Build Linux x86_64 CLI
        uses: ./.github/actions/ray-build
        with:
          system: linux
          arch: x86_64
          ref-label: ${{ needs.metadata.outputs.ref_label }}
          channel-hint: ${{ needs.metadata.outputs.channel_hint }}
          packages: |
            sudo apt-get update
            sudo apt-get install -y llvm-17 lld-17 liblld-17-dev libpolly-17-dev clang-17 libclang-17-dev
            echo "/usr/lib/llvm-17/bin" >> "$GITHUB_PATH"

  linux-arm64:
    needs: metadata
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Build Linux arm64 CLI
        uses: ./.github/actions/ray-build
        with:
          system: linux
          arch: arm64
          ref-label: ${{ needs.metadata.outputs.ref_label }}
          channel-hint: ${{ needs.metadata.outputs.channel_hint }}
          packages: |
            sudo apt-get update
            sudo apt-get install -y llvm-17 lld-17 liblld-17-dev libpolly-17-dev clang-17 libclang-17-dev
            echo "/usr/lib/llvm-17/bin" >> "$GITHUB_PATH"

  macos-arm64:
    needs: metadata
    runs-on: macos-15
    steps:
      - name: Build macOS arm64 CLI
        uses: ./.github/actions/ray-build
        with:
          system: macos
          arch: arm64
          ref-label: ${{ needs.metadata.outputs.ref_label }}
          channel-hint: ${{ needs.metadata.outputs.channel_hint }}
          packages: |
            brew update
            brew install llvm@17
            LLVM_PREFIX=$(brew --prefix llvm@17)
            echo "$LLVM_PREFIX/bin" >> "$GITHUB_PATH"

  macos-x86_64:
    needs: metadata
    runs-on: macos-15-intel
    steps:
      - name: Build macOS x86_64 CLI
        uses: ./.github/actions/ray-build
        with:
          system: macos
          arch: x86_64
          ref-label: ${{ needs.metadata.outputs.ref_label }}
          channel-hint: ${{ needs.metadata.outputs.channel_hint }}
          packages: |
            brew update
            brew install llvm@17
            LLVM_PREFIX=$(brew --prefix llvm@17)
            echo "$LLVM_PREFIX/bin" >> "$GITHUB_PATH"

  windows-x86_64:
    needs: metadata
    runs-on: windows-2025
    steps:
      - name: Build Windows x86_64 CLI
        uses: ./.github/actions/ray-build
        with:
          system: windows
          arch: x86_64
          ref-label: ${{ needs.metadata.outputs.ref_label }}
          channel-hint: ${{ needs.metadata.outputs.channel_hint }}
          packages: |
            choco install llvm --version=17.0.1 -y
            echo 'C:/Program Files/LLVM/bin' >> "$GITHUB_PATH"

  windows-arm64:
    needs: metadata
    runs-on: windows-11-arm
    steps:
      - name: Build Windows arm64 CLI
        uses: ./.github/actions/ray-build
        with:
          system: windows
          arch: arm64
          ref-label: ${{ needs.metadata.outputs.ref_label }}
          channel-hint: ${{ needs.metadata.outputs.channel_hint }}
          packages: |
            choco install llvm --version=17.0.1 -y
            echo 'C:/Program Files/LLVM/bin' >> "$GITHUB_PATH"

  toolchain:
    needs: 
      - metadata
      - linux-x86_64
    runs-on: ubuntu-latest
    env:
      REF_LABEL: ${{ needs.metadata.outputs.ref_label }}
      CHANNEL_HINT: ${{ needs.metadata.outputs.channel_hint }}
      TOOLCHAIN_BASENAME: ray-toolchain-${{ needs.metadata.outputs.ref_label }}
      LINUX_CLI_BASENAME: ray-cli-linux-x86_64-${{ needs.metadata.outputs.ref_label }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Linux CLI artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.LINUX_CLI_BASENAME }}
          path: dist

      - name: Install CLI artifact
        run: |
          mkdir -p target/release
          cp dist/${LINUX_CLI_BASENAME} target/release/ray
          chmod +x target/release/ray

      - name: Prepare toolchain layout
        run: |
          mkdir -p build/toolchain/lib build/toolchain/build
          ./target/release/ray --root-path $PWD/build/toolchain build lib/core --lib --no-core
          cp build/toolchain/build/core.raylib build/toolchain/lib/core.raylib
          printf 'version = "%s"\nchannel = "%s"\n' "${REF_LABEL}" "${CHANNEL_HINT}" > build/toolchain/manifest.toml
          rm -rf build/toolchain/build

      - name: Archive toolchain
        run: |
          tar -C build/toolchain -cf ${TOOLCHAIN_BASENAME}.tar .
          zstd -q ${TOOLCHAIN_BASENAME}.tar
          mv ${TOOLCHAIN_BASENAME}.tar.zst build/${TOOLCHAIN_BASENAME}.tar.zst
          rm ${TOOLCHAIN_BASENAME}.tar

      - name: Generate checksum
        run: |
          shasum -a 256 build/${TOOLCHAIN_BASENAME}.tar.zst > build/${TOOLCHAIN_BASENAME}.tar.zst.sha256

      - name: Upload toolchain artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.TOOLCHAIN_BASENAME }}
          path: |
            build/${{ env.TOOLCHAIN_BASENAME }}.tar.zst
            build/${{ env.TOOLCHAIN_BASENAME }}.tar.zst.sha256

      - name: Upload toolchain archive to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/${{ env.TOOLCHAIN_BASENAME }}.tar.zst
          asset_name: ${{ env.TOOLCHAIN_BASENAME }}.tar.zst
          tag: ${{ env.REF_LABEL }}
          release_name: ${{ env.REF_LABEL }}
          prerelease: ${{ github.ref_type != 'tag' }}
          overwrite: true

      - name: Upload toolchain checksum to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/${{ env.TOOLCHAIN_BASENAME }}.tar.zst.sha256
          asset_name: ${{ env.TOOLCHAIN_BASENAME }}.tar.zst.sha256
          tag: ${{ env.REF_LABEL }}
          release_name: ${{ env.REF_LABEL }}
          prerelease: ${{ github.ref_type != 'tag' }}
          overwrite: true

      - name: Upload manifest to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/toolchain/manifest.toml
          asset_name: ray-toolchain-manifest-${{ env.REF_LABEL }}.toml
          tag: ${{ env.REF_LABEL }}
          release_name: ${{ env.REF_LABEL }}
          prerelease: ${{ github.ref_type != 'tag' }}
          overwrite: true

  prune-nightlies:
    needs:
      - linux-x86_64
      - linux-arm64
      - macos-arm64
      - macos-x86_64
      - windows-x86_64
      - windows-arm64
      - toolchain
    if: github.ref_type != 'tag'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout-cone-mode: false
          sparse-checkout: ''
          depth: 1

      - name: Prune old nightly releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eo pipefail
          nightlies=$(gh release list --limit 100 --json tagName --jq 'map(.tagName) | map(select(startswith("nightly-"))) | sort')
          count=$(echo "$nightlies" | jq 'length')
          if [ "$count" -le 7 ]; then
            exit 0
          fi
          to_delete_count=$((count - 7))
          tags=$(echo "$nightlies" | jq -r '.[0:'"$to_delete_count"']')
          for tag in $tags; do
            gh release delete "$tag" --cleanup-tag -y || true
          done
